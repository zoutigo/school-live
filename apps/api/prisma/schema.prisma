generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlatformRole {
  SUPER_ADMIN
  ADMIN
  SALES
  SUPPORT
}

enum SchoolRole {
  SCHOOL_ADMIN
  SCHOOL_MANAGER
  SCHOOL_ACCOUNTANT
  TEACHER
  PARENT
  STUDENT
}

enum AppRole {
  SUPER_ADMIN
  ADMIN
  SALES
  SUPPORT
  SCHOOL_ADMIN
  SCHOOL_MANAGER
  SCHOOL_ACCOUNTANT
  TEACHER
  PARENT
  STUDENT
}

enum RecoveryQuestionKey {
  MOTHER_MAIDEN_NAME
  FAVORITE_SPORT
  FAVORITE_TEACHER
  BIRTH_CITY
  CHILDHOOD_NICKNAME
  FAVORITE_BOOK
}

enum Term {
  TERM_1
  TERM_2
  TERM_3
}

enum EnrollmentStatus {
  ACTIVE
  TRANSFERRED
  WITHDRAWN
  GRADUATED
}

enum OverrideAction {
  ADD
  REMOVE
}


model School {
  id                 String                @id @default(cuid())
  slug               String                @unique
  name               String
  logoUrl            String?
  primaryColor       String?
  activeSchoolYearId String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  activeSchoolYear   SchoolYear?           @relation("ActiveSchoolYear", fields: [activeSchoolYearId], references: [id], onDelete: SetNull)
  schoolYears        SchoolYear[]          @relation("SchoolYears")
  memberships        SchoolMembership[]
  classGroups        ClassGroup[]
  students           Student[]
  teachers           Teacher[]
  classes            Class[]
  subjects           Subject[]
  assignments        TeacherClassSubject[]
  grades             Grade[]
  enrollments        Enrollment[]
  classSubjectOverrides ClassSubjectOverride[]
  academicLevels     AcademicLevel[]
  tracks             Track[]
  curriculums        Curriculum[]
  curriculumSubjects CurriculumSubject[]

  @@index([activeSchoolYearId])
}

model User {
  id                 String                   @id @default(cuid())
  email              String                   @unique
  phone              String?
  avatarUrl          String?
  passwordHash       String
  mustChangePassword Boolean                  @default(false)
  profileCompleted   Boolean                  @default(true)
  activeRole         AppRole?
  recoveryBirthDate  DateTime?
  recoveryClassId    String?
  recoveryStudentId  String?
  firstName          String                   @map("firstname")
  lastName           String                   @map("lastname")
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  platformRoles      PlatformRoleAssignment[]
  memberships        SchoolMembership[]
  teacherProfiles    Teacher[]
  studentProfiles    Student[]
  parentLinks        ParentStudent[]          @relation("ParentLinks")
  gradesGiven        Grade[]                  @relation("GradeTeacher")
  teachingAssignments TeacherClassSubject[]
  refreshTokens      RefreshToken[]
  recoveryAnswers    UserRecoveryAnswer[]
}

model PlatformRoleAssignment {
  id        String       @id @default(cuid())
  userId    String
  role      PlatformRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model SchoolMembership {
  id        String    @id @default(cuid())
  userId    String
  schoolId  String
  role      SchoolRole
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId, role])
  @@index([schoolId])
  @@index([role])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}


model Student {
  id          String          @id @default(cuid())
  schoolId    String
  userId      String?
  firstName   String
  lastName    String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user        User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  parentLinks ParentStudent[] @relation("StudentLinks")
  grades      Grade[]
  enrollments Enrollment[]

  @@index([schoolId])
  @@unique([schoolId, userId])
}

model Enrollment {
  id           String           @id @default(cuid())
  schoolId     String
  schoolYearId String
  studentId    String
  classId      String
  status       EnrollmentStatus @default(ACTIVE)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear   SchoolYear       @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  student      Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class            @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([schoolYearId, studentId])
  @@index([schoolId])
  @@index([schoolYearId])
  @@index([classId])
  @@index([studentId])
}

model ParentStudent {
  id           String   @id @default(cuid())
  schoolId     String
  parentUserId String
  studentId    String
  createdAt    DateTime @default(now())
  parent       User     @relation("ParentLinks", fields: [parentUserId], references: [id], onDelete: Cascade)
  student      Student  @relation("StudentLinks", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentUserId, studentId])
  @@index([schoolId])
  @@index([studentId])
}

model Teacher {
  id        String   @id @default(cuid())
  schoolId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@unique([schoolId, userId])
}

model UserRecoveryAnswer {
  id          String              @id @default(cuid())
  userId      String
  questionKey RecoveryQuestionKey
  answerHash  String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionKey])
  @@index([userId])
}


model ClassGroup {
  id        String   @id @default(cuid())
  schoolId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes   Class[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model SchoolYear {
  id                  String                @id @default(cuid())
  schoolId            String
  label               String
  startsAt            DateTime?
  endsAt              DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  school              School                @relation("SchoolYears", fields: [schoolId], references: [id], onDelete: Cascade)
  activeForSchools    School[]              @relation("ActiveSchoolYear")
  classes             Class[]
  enrollments         Enrollment[]
  teachingAssignments TeacherClassSubject[]
  grades              Grade[]

  @@unique([schoolId, label])
  @@index([schoolId])
}

model AcademicLevel {
  id          String       @id @default(cuid())
  schoolId    String
  code        String
  label       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     Class[]
  curriculums Curriculum[]

  @@unique([schoolId, code])
  @@index([schoolId])
}

model Track {
  id          String       @id @default(cuid())
  schoolId    String
  code        String
  label       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     Class[]
  curriculums Curriculum[]

  @@unique([schoolId, code])
  @@index([schoolId])
}

model Curriculum {
  id              String              @id @default(cuid())
  schoolId        String
  name            String
  academicLevelId String
  trackId         String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  school          School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicLevel   AcademicLevel       @relation(fields: [academicLevelId], references: [id], onDelete: Cascade)
  track           Track?              @relation(fields: [trackId], references: [id], onDelete: SetNull)
  classes         Class[]
  subjects        CurriculumSubject[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([academicLevelId])
  @@index([trackId])
}

model CurriculumSubject {
  id           String     @id @default(cuid())
  schoolId     String
  curriculumId String
  subjectId    String
  isMandatory  Boolean    @default(true)
  coefficient  Float?
  weeklyHours  Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  school       School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  subject      Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([curriculumId, subjectId])
  @@index([schoolId])
  @@index([subjectId])
}

model Class {
  id              String                @id @default(cuid())
  schoolId        String
  schoolYearId    String
  classGroupId    String?
  academicLevelId String?
  trackId         String?
  curriculumId    String?
  name            String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear      SchoolYear            @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  classGroup      ClassGroup?           @relation(fields: [classGroupId], references: [id], onDelete: SetNull)
  academicLevel   AcademicLevel?        @relation(fields: [academicLevelId], references: [id], onDelete: SetNull)
  track           Track?                @relation(fields: [trackId], references: [id], onDelete: SetNull)
  curriculum      Curriculum?           @relation(fields: [curriculumId], references: [id], onDelete: SetNull)
  enrollments     Enrollment[]
  assignments     TeacherClassSubject[]
  grades          Grade[]
  subjectOverrides ClassSubjectOverride[]

  @@unique([schoolId, schoolYearId, classGroupId, name])
  @@index([schoolId])
  @@index([schoolYearId])
  @@index([classGroupId])
  @@index([academicLevelId])
  @@index([trackId])
  @@index([curriculumId])
}

model Subject {
  id           String                @id @default(cuid())
  schoolId     String
  name         String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  school       School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignments  TeacherClassSubject[]
  grades       Grade[]
  curriculumSubjects CurriculumSubject[]
  classOverrides ClassSubjectOverride[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model ClassSubjectOverride {
  id                    String         @id @default(cuid())
  schoolId              String
  classId               String
  subjectId             String
  action                OverrideAction
  coefficientOverride   Float?
  weeklyHoursOverride   Float?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  school                School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class                 Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject               Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId])
  @@index([schoolId])
  @@index([classId])
  @@index([subjectId])
}

model TeacherClassSubject {
  id            String     @id @default(cuid())
  schoolId      String
  schoolYearId  String
  teacherUserId String
  classId       String
  subjectId     String
  createdAt     DateTime   @default(now())
  school        School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear    SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  teacherUser   User       @relation(fields: [teacherUserId], references: [id], onDelete: Cascade)
  class         Class      @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject       Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([schoolYearId, teacherUserId, classId, subjectId])
  @@index([schoolId])
  @@index([schoolYearId])
  @@index([classId])
  @@index([subjectId])
}


model Grade {
  id            String   @id @default(cuid())
  schoolId      String
  schoolYearId  String
  studentId     String
  classId       String
  subjectId     String
  teacherUserId String
  value         Float
  maxValue      Float
  assessmentWeight Float @default(1)
  term          Term
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  school        School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear    SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  student       Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class         Class      @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject       Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherUser   User       @relation("GradeTeacher", fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([schoolYearId])
  @@index([studentId])
  @@index([classId])
  @@index([subjectId])
  @@index([teacherUserId])
}


// Reserved for future shared indexes, comments and data notes.


