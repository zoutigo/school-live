generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlatformRole {
  SUPER_ADMIN
  ADMIN
  SALES
  SUPPORT
}

enum SchoolRole {
  SCHOOL_ADMIN
  SCHOOL_MANAGER
  SCHOOL_ACCOUNTANT
  TEACHER
  PARENT
  STUDENT
}

enum RecoveryQuestionKey {
  MOTHER_MAIDEN_NAME
  FAVORITE_SPORT
  FAVORITE_TEACHER
  BIRTH_CITY
  CHILDHOOD_NICKNAME
  FAVORITE_BOOK
}

enum Term {
  TERM_1
  TERM_2
  TERM_3
}

model School {
  id           String                @id @default(cuid())
  slug         String                @unique
  name         String
  logoUrl      String?
  primaryColor String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  memberships  SchoolMembership[]
  classGroups  ClassGroup[]
  students     Student[]
  teachers     Teacher[]
  classes      Class[]
  subjects     Subject[]
  assignments  TeacherClassSubject[]
  grades       Grade[]
}

model ClassGroup {
  id        String   @id @default(cuid())
  schoolId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes   Class[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model User {
  id                  String                   @id @default(cuid())
  email               String                   @unique
  phone               String?
  avatarUrl           String?
  passwordHash        String
  mustChangePassword  Boolean                  @default(false)
  profileCompleted    Boolean                  @default(true)
  recoveryBirthDate   DateTime?
  recoveryClassId     String?
  recoveryStudentId   String?
  firstName           String                   @map("firstname")
  lastName            String                   @map("lastname")
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  platformRoles       PlatformRoleAssignment[]
  memberships         SchoolMembership[]
  teacherProfiles     Teacher[]
  studentProfiles     Student[]
  parentLinks         ParentStudent[]          @relation("ParentLinks")
  gradesGiven         Grade[]                  @relation("GradeTeacher")
  teachingAssignments TeacherClassSubject[]
  refreshTokens       RefreshToken[]
  recoveryAnswers     UserRecoveryAnswer[]
}

model UserRecoveryAnswer {
  id          String              @id @default(cuid())
  userId      String
  questionKey RecoveryQuestionKey
  answerHash  String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionKey])
  @@index([userId])
}

model PlatformRoleAssignment {
  id        String       @id @default(cuid())
  userId    String
  role      PlatformRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model SchoolMembership {
  id        String     @id @default(cuid())
  userId    String
  schoolId  String
  role      SchoolRole
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId, role])
  @@index([schoolId])
  @@index([role])
}

model RefreshToken {
  id           String    @id @default(cuid())
  userId       String
  tokenHash    String    @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Student {
  id          String          @id @default(cuid())
  schoolId    String
  userId      String?
  firstName   String
  lastName    String
  classId     String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user        User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  class       Class?          @relation(fields: [classId], references: [id], onDelete: SetNull)
  parentLinks ParentStudent[] @relation("StudentLinks")
  grades      Grade[]

  @@unique([schoolId, userId])
  @@index([schoolId])
  @@index([classId])
}

model ParentStudent {
  id           String   @id @default(cuid())
  schoolId     String
  parentUserId String
  studentId    String
  createdAt    DateTime @default(now())
  parent       User     @relation("ParentLinks", fields: [parentUserId], references: [id], onDelete: Cascade)
  student      Student  @relation("StudentLinks", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentUserId, studentId])
  @@index([schoolId])
  @@index([studentId])
}

model Teacher {
  id        String   @id @default(cuid())
  schoolId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([schoolId, userId])
  @@index([schoolId])
}

model Class {
  id          String                @id @default(cuid())
  schoolId    String
  classGroupId String?
  name        String
  year        String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  school      School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classGroup  ClassGroup?           @relation(fields: [classGroupId], references: [id], onDelete: SetNull)
  students    Student[]
  assignments TeacherClassSubject[]
  grades      Grade[]

  @@unique([schoolId, classGroupId, name, year])
  @@index([schoolId])
  @@index([classGroupId])
}

model Subject {
  id          String                @id @default(cuid())
  schoolId    String
  name        String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  school      School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignments TeacherClassSubject[]
  grades      Grade[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model TeacherClassSubject {
  id            String   @id @default(cuid())
  schoolId      String
  teacherUserId String
  classId       String
  subjectId     String
  createdAt     DateTime @default(now())
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacherUser   User     @relation(fields: [teacherUserId], references: [id], onDelete: Cascade)
  class         Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherUserId, classId, subjectId])
  @@index([schoolId])
  @@index([classId])
  @@index([subjectId])
}

model Grade {
  id            String   @id @default(cuid())
  schoolId      String
  studentId     String
  classId       String
  subjectId     String
  teacherUserId String
  value         Float
  maxValue      Float
  term          Term
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class         Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherUser   User     @relation("GradeTeacher", fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([studentId])
  @@index([classId])
  @@index([subjectId])
  @@index([teacherUserId])
}

// Reserved for future shared indexes, comments and data notes.
