model School {
  id                 String                @id @default(cuid())
  slug               String                @unique
  name               String
  logoUrl            String?
  primaryColor       String?
  activeSchoolYearId String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  activeSchoolYear   SchoolYear?           @relation("ActiveSchoolYear", fields: [activeSchoolYearId], references: [id], onDelete: SetNull)
  schoolYears        SchoolYear[]          @relation("SchoolYears")
  memberships        SchoolMembership[]
  classGroups        ClassGroup[]
  students           Student[]
  teachers           Teacher[]
  classes            Class[]
  subjects           Subject[]
  assignments        TeacherClassSubject[]
  grades             Grade[]
  enrollments        Enrollment[]
  classSubjectOverrides ClassSubjectOverride[]
  academicLevels     AcademicLevel[]
  tracks             Track[]
  curriculums        Curriculum[]
  curriculumSubjects CurriculumSubject[]

  @@index([activeSchoolYearId])
}

model User {
  id                 String                   @id @default(cuid())
  email              String                   @unique
  phone              String?
  avatarUrl          String?
  passwordHash       String
  mustChangePassword Boolean                  @default(false)
  profileCompleted   Boolean                  @default(true)
  recoveryBirthDate  DateTime?
  recoveryClassId    String?
  recoveryStudentId  String?
  firstName          String                   @map("firstname")
  lastName           String                   @map("lastname")
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  platformRoles      PlatformRoleAssignment[]
  memberships        SchoolMembership[]
  teacherProfiles    Teacher[]
  studentProfiles    Student[]
  parentLinks        ParentStudent[]          @relation("ParentLinks")
  gradesGiven        Grade[]                  @relation("GradeTeacher")
  teachingAssignments TeacherClassSubject[]
  refreshTokens      RefreshToken[]
  recoveryAnswers    UserRecoveryAnswer[]
}

model PlatformRoleAssignment {
  id        String       @id @default(cuid())
  userId    String
  role      PlatformRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model SchoolMembership {
  id        String    @id @default(cuid())
  userId    String
  schoolId  String
  role      SchoolRole
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId, role])
  @@index([schoolId])
  @@index([role])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
