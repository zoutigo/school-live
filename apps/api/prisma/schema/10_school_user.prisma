model School {
  id                 String                @id @default(cuid())
  slug               String                @unique
  name               String
  country            String?
  region             String?
  city               String?
  logoUrl            String?
  primaryColor       String?
  activeSchoolYearId String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  activeSchoolYear   SchoolYear?           @relation("ActiveSchoolYear", fields: [activeSchoolYearId], references: [id], onDelete: SetNull)
  schoolYears        SchoolYear[]          @relation("SchoolYears")
  memberships        SchoolMembership[]
  classGroups        ClassGroup[]
  students           Student[]
  teachers           Teacher[]
  classes            Class[]
  subjects           Subject[]
  assignments        TeacherClassSubject[]
  grades             Grade[]
  enrollments        Enrollment[]
  classSubjectOverrides ClassSubjectOverride[]
  academicLevels     AcademicLevel[]
  tracks             Track[]
  curriculums        Curriculum[]
  curriculumSubjects CurriculumSubject[]
  lifeEvents         StudentLifeEvent[]
  staffFunctions     SchoolStaffFunction[]
  staffAssignments   SchoolStaffAssignment[]
  internalMessages   InternalMessage[]
  messageRecipients  InternalMessageRecipient[]
  feedPosts          FeedPost[]
  feedComments       FeedComment[]
  feedLikes          FeedLike[]

  @@index([activeSchoolYearId])
}

model User {
  id                 String                   @id @default(cuid())
  email              String                   @unique
  phone              String?
  avatarUrl          String?
  passwordHash       String
  mustChangePassword Boolean                  @default(false)
  profileCompleted   Boolean                  @default(true)
  activeRole         AppRole?
  recoveryBirthDate  DateTime?
  recoveryClassId    String?
  recoveryStudentId  String?
  firstName          String                   @map("firstname")
  lastName           String                   @map("lastname")
  gender             Gender?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  platformRoles      PlatformRoleAssignment[]
  memberships        SchoolMembership[]
  teacherProfiles    Teacher[]
  studentProfiles    Student[]
  parentLinks        ParentStudent[]          @relation("ParentLinks")
  gradesGiven        Grade[]                  @relation("GradeTeacher")
  teachingAssignments TeacherClassSubject[]
  refreshTokens      RefreshToken[]
  recoveryAnswers    UserRecoveryAnswer[]
  lifeEventsAuthored StudentLifeEvent[]       @relation("LifeEventAuthor")
  staffAssignments   SchoolStaffAssignment[]
  sentMessages       InternalMessage[]         @relation("InternalMessageSender")
  receivedMessages   InternalMessageRecipient[] @relation("InternalMessageRecipientUser")
  feedPosts          FeedPost[]                @relation("FeedPostAuthor")
  feedComments       FeedComment[]             @relation("FeedCommentAuthor")
  feedLikes          FeedLike[]                @relation("FeedLikeUser")
}

model PlatformRoleAssignment {
  id        String       @id @default(cuid())
  userId    String
  role      PlatformRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model SchoolMembership {
  id        String    @id @default(cuid())
  userId    String
  schoolId  String
  role      SchoolRole
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId, role])
  @@index([schoolId])
  @@index([role])
}

model SchoolStaffFunction {
  id          String                 @id @default(cuid())
  schoolId    String
  name        String
  description String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  school      School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignments SchoolStaffAssignment[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model SchoolStaffAssignment {
  id         String             @id @default(cuid())
  schoolId   String
  functionId String
  userId     String
  createdAt  DateTime           @default(now())
  school     School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  function   SchoolStaffFunction @relation(fields: [functionId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([schoolId, functionId, userId])
  @@index([schoolId])
  @@index([functionId])
  @@index([userId])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
